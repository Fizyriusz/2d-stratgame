<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MassiveWars - Demo</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #222;
            color: white;
        }
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            background-color: #0f380f;
        }
        #ui {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
        }
        .resources {
            display: flex;
            margin-right: 20px;
        }
        .resource {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }
        .resource-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .gold-icon {
            background-color: gold;
        }
        .wood-icon {
            background-color: brown;
        }
        .food-icon {
            background-color: green;
        }
        .population-icon {
            background-color: white;
        }
        .buttons {
            display: flex;
        }
        .btn {
            margin-right: 10px;
            padding: 8px 12px;
            background-color: #444;
            border: 1px solid #666;
            color: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .btn:hover {
            background-color: #555;
        }
        .btn.selected {
            background-color: #2a6496;
        }
        #minimap {
            position: absolute;
            right: 10px;
            bottom: 110px;
            width: 200px;
            height: 200px;
            border: 2px solid white;
            background-color: #0f380f;
        }
        #tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 5px 10px;
            border-radius: 3px;
            pointer-events: none;
            display: none;
            z-index: 100;
            white-space: nowrap;
        }
        #fps-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <canvas id="minimap"></canvas>
        <div id="ui">
            <div class="resources">
                <div class="resource">
                    <div class="resource-icon gold-icon"></div>
                    <span id="gold">500</span>
                </div>
                <div class="resource">
                    <div class="resource-icon wood-icon"></div>
                    <span id="wood">300</span>
                </div>
                <div class="resource">
                    <div class="resource-icon food-icon"></div>
                    <span id="food">400</span>
                </div>
                <div class="resource">
                    <div class="resource-icon population-icon"></div>
                    <span id="population">10/15</span>
                </div>
            </div>
            <div class="buttons">
                <button class="btn" id="buildTownHall" data-tooltip="Buduj Ratusz (300 złota, 200 drewna)">Ratusz</button>
                <button class="btn" id="buildHouse" data-tooltip="Buduj Dom (100 złota, 150 drewna)">Dom</button>
                <button class="btn" id="buildBarrack" data-tooltip="Buduj Koszary (200 złota, 150 drewna)">Koszary</button>
                <button class="btn" id="trainWorker" data-tooltip="Wytrenuj Pracownika (50 złota, 0 drewna)">Pracownik</button>
                <button class="btn" id="trainWarrior" data-tooltip="Wytrenuj Wojownika (100 złota, 0 drewna)">Wojownik</button>
                <button class="btn" id="trainArcher" data-tooltip="Wytrenuj Łucznika (75 złota, 50 drewna)">Łucznik</button>
            </div>
        </div>
        <div id="tooltip"></div>
        <div id="fps-counter">FPS: 0</div>
    </div>

    <script>
        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.minimap = document.getElementById('minimap');
                this.minimapCtx = this.minimap.getContext('2d');
                
                // Rozmiar świata gry
                this.worldWidth = 4000;
                this.worldHeight = 4000;
                
                // Ustawienia kamery
                this.camera = {
                    x: this.worldWidth / 2,
                    y: this.worldHeight / 2,
                    width: 0,
                    height: 0,
                    scale: 1
                };
                
                // Zasoby gracza
                this.player = {
                    gold: 500,
                    wood: 300,
                    food: 400,
                    population: 10,
                    populationLimit: 15,
                    color: 'blue',
                    buildings: [],
                    units: []
                };
                
                // Przeciwnik (AI)
                this.enemy = {
                    gold: 500,
                    wood: 300,
                    food: 400,
                    population: 10,
                    populationLimit: 15,
                    color: 'red',
                    buildings: [],
                    units: []
                };

                // Teren
                this.terrain = {
                    trees: [],
                    goldMines: []
                };
                
                // Tryb budowania
                this.buildMode = null;
                
                // Wybrane jednostki
                this.selectedUnits = [];
                
                // Interakcja myszy
                this.mouse = {
                    x: 0,
                    y: 0,
                    worldX: 0,
                    worldY: 0,
                    down: false,
                    startX: 0,
                    startY: 0,
                    selectionBox: {
                        startX: 0,
                        startY: 0,
                        endX: 0,
                        endY: 0,
                        active: false
                    }
                };
                
                // FPS counter
                this.fps = 0;
                this.lastTimestamp = 0;
                this.fpsCounter = document.getElementById('fps-counter');
                
                // Inicjalizacja gry
                this.init();
            }
            
            init() {
                console.log("Initializing game...");
                
                // Ustawienia rozmiaru canvas
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // Obsługa myszy
                this.canvas.addEventListener('mousedown', (e) => {
                    console.log("Mouse down on canvas:", e.clientX, e.clientY, "Button:", e.button);
                    this.handleMouseDown(e);
                });
                
                this.canvas.addEventListener('mousemove', (e) => {
                    this.handleMouseMove(e);
                });
                
                this.canvas.addEventListener('mouseup', (e) => {
                    console.log("Mouse up on canvas:", e.clientX, e.clientY);
                    this.handleMouseUp(e);
                });
                
                this.canvas.addEventListener('wheel', (e) => {
                    this.handleMouseWheel(e);
                });
                
                // Obsługa myszy dla minimapy
                this.minimap.addEventListener('mousedown', (e) => {
                    console.log("Mouse down on minimap:", e.clientX, e.clientY);
                    const minimapRect = this.minimap.getBoundingClientRect();
                    const minimapX = e.clientX - minimapRect.left;
                    const minimapY = e.clientY - minimapRect.top;
                    
                    // Przesunięcie kamery do miejsca kliknięcia na minimapie
                    this.camera.x = (minimapX / this.minimap.width) * this.worldWidth;
                    this.camera.y = (minimapY / this.minimap.height) * this.worldHeight;
                });
                
                // Obsługa klawiszy
                window.addEventListener('keydown', (e) => {
                    console.log("Key down:", e.key);
                    this.handleKeyDown(e);
                });
                
                // Przyciski UI
                document.getElementById('buildTownHall').addEventListener('click', () => {
                    console.log("Build Town Hall button clicked");
                    this.setBuildMode('townHall');
                });
                
                document.getElementById('buildHouse').addEventListener('click', () => {
                    console.log("Build House button clicked");
                    this.setBuildMode('house');
                });
                
                document.getElementById('buildBarrack').addEventListener('click', () => {
                    console.log("Build Barrack button clicked");
                    this.setBuildMode('barrack');
                });
                
                document.getElementById('trainWorker').addEventListener('click', () => {
                    console.log("Train Worker button clicked");
                    this.trainUnit('worker');
                });
                
                document.getElementById('trainWarrior').addEventListener('click', () => {
                    console.log("Train Warrior button clicked");
                    this.trainUnit('warrior');
                });
                
                document.getElementById('trainArcher').addEventListener('click', () => {
                    console.log("Train Archer button clicked");
                    this.trainUnit('archer');
                });
                
                // Tooltips
                const buttons = document.querySelectorAll('.btn');
                const tooltip = document.getElementById('tooltip');
                
                buttons.forEach(button => {
                    button.addEventListener('mouseover', (e) => {
                        const rect = button.getBoundingClientRect();
                        tooltip.textContent = button.getAttribute('data-tooltip');
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${rect.left}px`;
                        tooltip.style.top = `${rect.top - 30}px`;
                    });
                    
                    button.addEventListener('mouseout', () => {
                        tooltip.style.display = 'none';
                    });
                });
                
                // Generowanie terenu
                this.generateTerrain();
                
                // Dodawanie początkowych jednostek i budynków
                this.createInitialEntities();
                
                // Start pętli gry
                console.log("Starting game loop...");
                requestAnimationFrame((timestamp) => this.gameLoop(timestamp));
            }
            
            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight - 100; // Odjąć wysokość UI
                this.camera.width = this.canvas.width;
                this.camera.height = this.canvas.height;
                
                // Aktualizacja minimapy
                this.minimap.width = 200;
                this.minimap.height = 200;
                
                console.log("Canvas resized:", this.canvas.width, this.canvas.height);
                console.log("Minimap resized:", this.minimap.width, this.minimap.height);
            }
            
            generateTerrain() {
                console.log("Generating terrain...");
                
                // Losowe drzewa
                for (let i = 0; i < 200; i++) {
                    this.terrain.trees.push({
                        x: Math.random() * this.worldWidth,
                        y: Math.random() * this.worldHeight,
                        size: 10 + Math.random() * 10,
                        resources: 100 + Math.floor(Math.random() * 100)
                    });
                }
                
                // Losowe kopalnie złota
                for (let i = 0; i < 20; i++) {
                    this.terrain.goldMines.push({
                        x: Math.random() * this.worldWidth,
                        y: Math.random() * this.worldHeight,
                        size: 30,
                        resources: 1000 + Math.floor(Math.random() * 1000)
                    });
                }
                
                console.log("Terrain generated:", this.terrain.trees.length, "trees,", this.terrain.goldMines.length, "gold mines");
            }
            
            createInitialEntities() {
                console.log("Creating initial entities...");
                
                // Początkowe budynki gracza (ratusz)
                this.player.buildings.push({
                    type: 'townHall',
                    x: this.worldWidth / 4,
                    y: this.worldHeight / 2,
                    width: 80,
                    height: 80,
                    health: 1000,
                    maxHealth: 1000
                });
                
                // Początkowe jednostki gracza (pracownicy)
                for (let i = 0; i < 10; i++) {
                    this.player.units.push({
                        type: 'worker',
                        x: this.worldWidth / 4 + (Math.random() * 100 - 50),
                        y: this.worldHeight / 2 + (Math.random() * 100 - 50),
                        targetX: null,
                        targetY: null,
                        size: 8,
                        speed: 1.5,
                        health: 50,
                        maxHealth: 50,
                        attack: 5,
                        range: 10,
                        attackSpeed: 1,
                        lastAttack: 0,
                        selected: false,
                        task: null,
                        taskTarget: null
                    });
                }
                
                // Początkowe budynki przeciwnika (ratusz)
                this.enemy.buildings.push({
                    type: 'townHall',
                    x: (this.worldWidth / 4) * 3,
                    y: this.worldHeight / 2,
                    width: 80,
                    height: 80,
                    health: 1000,
                    maxHealth: 1000
                });
                
                // Początkowe jednostki przeciwnika (pracownicy)
                for (let i = 0; i < 10; i++) {
                    this.enemy.units.push({
                        type: 'worker',
                        x: (this.worldWidth / 4) * 3 + (Math.random() * 100 - 50),
                        y: this.worldHeight / 2 + (Math.random() * 100 - 50),
                        targetX: null,
                        targetY: null,
                        size: 8,
                        speed: 1.5,
                        health: 50,
                        maxHealth: 50,
                        attack: 5,
                        range: 10,
                        attackSpeed: 1,
                        lastAttack: 0,
                        task: null,
                        taskTarget: null
                    });
                }
                
                console.log("Initial entities created:", 
                    this.player.buildings.length, "player buildings,", 
                    this.player.units.length, "player units,",
                    this.enemy.buildings.length, "enemy buildings,",
                    this.enemy.units.length, "enemy units");
            }
            
            gameLoop(timestamp) {
                // Obliczanie FPS
                const deltaTime = timestamp - this.lastTimestamp;
                this.lastTimestamp = timestamp;
                this.fps = Math.round(1000 / deltaTime);
                this.fpsCounter.textContent = `FPS: ${this.fps}`;
                
                // Aktualizacja stanu gry
                this.update(deltaTime);
                
                // Renderowanie
                this.render();
                
                // Kontynuacja pętli
                requestAnimationFrame((timestamp) => this.gameLoop(timestamp));
            }
            
            update(deltaTime) {
                // Aktualizacja jednostek gracza
                this.updateUnits(this.player.units, this.enemy, deltaTime);
                
                // Aktualizacja jednostek przeciwnika
                this.updateUnits(this.enemy.units, this.player, deltaTime);
                
                // Prosta sztuczna inteligencja dla przeciwnika
                this.updateEnemyAI(deltaTime);
                
                // Aktualizacja UI
                this.updateUI();
            }
            
            updateUnits(units, opponent, deltaTime) {
                const timestamp = Date.now();
                
                for (let unit of units) {
                    // Ruch jednostki do celu
                    if (unit.targetX !== null && unit.targetY !== null) {
                        const dx = unit.targetX - unit.x;
                        const dy = unit.targetY - unit.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance > 5) {
                            unit.x += (dx / distance) * unit.speed;
                            unit.y += (dy / distance) * unit.speed;
                        } else {
                            unit.targetX = null;
                            unit.targetY = null;
                        }
                    }
                    
                    // Wykonywanie zadań przez jednostki
                    if (unit.task === 'attack' && unit.taskTarget) {
                        // Atak budynku lub jednostki przeciwnika
                        const target = unit.taskTarget;
                        
                        // Sprawdź, czy cel nadal istnieje
                        let targetExists = false;
                        if (target.type) {
                            // To jest jednostka
                            targetExists = opponent.units.includes(target);
                        } else {
                            // To jest budynek
                            targetExists = opponent.buildings.includes(target);
                        }
                        
                        if (!targetExists) {
                            unit.task = null;
                            unit.taskTarget = null;
                            continue;
                        }
                        
                        const dx = target.x - unit.x;
                        const dy = target.y - unit.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance <= unit.range + (target.size || target.width / 2)) {
                            // W zasięgu ataku
                            if (timestamp - unit.lastAttack > 1000 / unit.attackSpeed) {
                                target.health -= unit.attack;
                                unit.lastAttack = timestamp;
                                
                                // Zniszczenie celu, jeśli zdrowie spadło do 0
                                if (target.health <= 0) {
                                    if (target.type) {
                                        // To jest jednostka
                                        const index = opponent.units.indexOf(target);
                                        if (index > -1) {
                                            opponent.units.splice(index, 1);
                                            opponent.population--;
                                        }
                                    } else {
                                        // To jest budynek
                                        const index = opponent.buildings.indexOf(target);
                                        if (index > -1) {
                                            opponent.buildings.splice(index, 1);
                                        }
                                    }
                                    
                                    // Resetowanie zadania
                                    unit.task = null;
                                    unit.taskTarget = null;
                                }
                            }
                        } else {
                            // Poza zasięgiem, podążaj za celem
                            unit.targetX = target.x;
                            unit.targetY = target.y;
                        }
                    } else if (unit.task === 'gather' && unit.taskTarget) {
                        // Zbieranie zasobów (drzewo lub złoto)
                        const target = unit.taskTarget;
                        
                        // Sprawdź, czy zasób nadal istnieje
                        let resourceExists = false;
                        if (this.terrain.trees.includes(target)) {
                            resourceExists = true;
                        } else if (this.terrain.goldMines.includes(target)) {
                            resourceExists = true;
                        }
                        
                        if (!resourceExists) {
                            unit.task = null;
                            unit.taskTarget = null;
                            continue;
                        }
                        
                        const dx = target.x - unit.x;
                        const dy = target.y - unit.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance <= 20) {
                            // W zasięgu zbierania
                            if (timestamp - unit.lastAttack > 1000) {
                                target.resources -= 5;
                                
                                // Dodawanie zasobów graczowi lub przeciwnikowi
                                if (units === this.player.units) {
                                    if (this.terrain.trees.includes(target)) {
                                        this.player.wood += 5;
                                    } else if (this.terrain.goldMines.includes(target)) {
                                        this.player.gold += 5;
                                    }
                                } else {
                                    if (this.terrain.trees.includes(target)) {
                                        this.enemy.wood += 5;
                                    } else if (this.terrain.goldMines.includes(target)) {
                                        this.enemy.gold += 5;
                                    }
                                }
                                
                                unit.lastAttack = timestamp;
                                
                                // Usunięcie zasobu, jeśli wyczerpany
                                if (target.resources <= 0) {
                                    if (this.terrain.trees.includes(target)) {
                                        const index = this.terrain.trees.indexOf(target);
                                        if (index > -1) {
                                            this.terrain.trees.splice(index, 1);
                                        }
                                    } else if (this.terrain.goldMines.includes(target)) {
                                        const index = this.terrain.goldMines.indexOf(target);
                                        if (index > -1) {
                                            this.terrain.goldMines.splice(index, 1);
                                        }
                                    }
                                    
                                    // Resetowanie zadania
                                    unit.task = null;
                                    unit.taskTarget = null;
                                }
                            }
                        } else {
                            // Poza zasięgiem, podążaj za zasobem
                            unit.targetX = target.x;
                            unit.targetY = target.y;
                        }
                    }
                }
            }
            
            updateEnemyAI(deltaTime) {
                // Prosta AI - przeciwnik buduje budynki i trenuje jednostki, jeśli ma zasoby
                if (this.enemy.buildings.length < 5 && this.enemy.gold >= 200 && this.enemy.wood >= 150) {
                    // Budowanie domu
                    const townHall = this.enemy.buildings.find(b => b.type === 'townHall');
                    if (townHall) {
                        this.enemy.buildings.push({
                            type: 'house',
                            x: townHall.x + Math.random() * 200 - 100,
                            y: townHall.y + Math.random() * 200 - 100,
                            width: 40,
                            height: 40,
                            health: 300,
                            maxHealth: 300
                        });
                        
                        this.enemy.gold -= 100;
                        this.enemy.wood -= 150;
                        this.enemy.populationLimit += 5;
                    }
                }
                
                // Trenowanie jednostek
                if (this.enemy.population < this.enemy.populationLimit && this.enemy.gold >= 50) {
                    // Sprawdź, czy istnieje ratusz
                    const townHall = this.enemy.buildings.find(b => b.type === 'townHall');
                    if (townHall) {
                        // 70% szans na pracownika, 30% na wojownika
                        if (Math.random() < 0.7 || this.enemy.units.length < 5) {
                            this.enemy.units.push({
                                type: 'worker',
                                x: townHall.x + Math.random() * 60 - 30,
                                y: townHall.y + Math.random() * 60 - 30,
                                targetX: null,
                                targetY: null,
                                size: 8,
                                speed: 1.5,
                                health: 50,
                                maxHealth: 50,
                                attack: 5,
                                range: 10,
                                attackSpeed: 1,
                                lastAttack: 0,
                                task: null,
                                taskTarget: null
                            });
                            
                            this.enemy.gold -= 50;
                            this.enemy.population++;
                        } else if (this.enemy.gold >= 100) {
                            this.enemy.units.push({
                                type: 'warrior',
                                x: townHall.x + Math.random() * 60 - 30,
                                y: townHall.y + Math.random() * 60 - 30,
                                targetX: null,
                                targetY: null,
                                size: 10,
                                speed: 1.2,
                                health: 100,
                                maxHealth: 100,
                                attack: 15,
                                range: 15,
                                attackSpeed: 1,
                                lastAttack: 0,
                                task: null,
                                taskTarget: null
                            });
                            
                            this.enemy.gold -= 100;
                            this.enemy.population++;
                        }
                    }
                }
                
                // Zarządzanie jednostkami
                for (let unit of this.enemy.units) {
                    // Jeśli jednostka nie ma zadania, znajdź coś do zrobienia
                    if (!unit.task) {
                        if (unit.type === 'worker') {
                            // Pracownicy zbierają zasoby
                            if (Math.random() < 0.5 && this.terrain.trees.length > 0) {
                                // Znajdź najbliższe drzewo
                                let nearestTree = null;
                                let minDistance = Infinity;
                                
                                for (let tree of this.terrain.trees) {
                                    const dx = tree.x - unit.x;
                                    const dy = tree.y - unit.y;
                                    const distance = Math.sqrt(dx * dx + dy * dy);
                                    
                                    if (distance < minDistance) {
                                        minDistance = distance;
                                        nearestTree = tree;
                                    }
                                }
                                
                                if (nearestTree) {
                                    unit.task = 'gather';
                                    unit.taskTarget = nearestTree;
                                    unit.targetX = nearestTree.x;
                                    unit.targetY = nearestTree.y;
                                }
                            } else if (this.terrain.goldMines.length > 0) {
                                // Znajdź najbliższą kopalnię złota
                                let nearestMine = null;
                                let minDistance = Infinity;
                                
                                for (let mine of this.terrain.goldMines) {
                                    const dx = mine.x - unit.x;
                                    const dy = mine.y - unit.y;
                                    const distance = Math.sqrt(dx * dx + dy * dy);
                                    
                                    if (distance < minDistance) {
                                        minDistance = distance;
                                        nearestMine = mine;
                                    }
                                }
                                
                                if (nearestMine) {
                                    unit.task = 'gather';
                                    unit.taskTarget = nearestMine;
                                    unit.targetX = nearestMine.x;
                                    unit.targetY = nearestMine.y;
                                }
                            }
                        } else if (unit.type === 'warrior' || unit.type === 'archer') {
                            // Wojownicy i łucznicy atakują
                            // 80% szans na atak jednostki, 20% na atak budynku
                            if (Math.random() < 0.8 && this.player.units.length > 0) {
                                // Atakuj losową jednostkę gracza
                                const targetIndex = Math.floor(Math.random() * this.player.units.length);
                                const target = this.player.units[targetIndex];
                                
                                unit.task = 'attack';
                                unit.taskTarget = target;
                                unit.targetX = target.x;
                                unit.targetY = target.y;
                            } else if (this.player.buildings.length > 0) {
                                // Atakuj losowy budynek gracza
                                const targetIndex = Math.floor(Math.random() * this.player.buildings.length);
                                const target = this.player.buildings[targetIndex];
                                
                                unit.task = 'attack';
                                unit.taskTarget = target;
                                unit.targetX = target.x;
                                unit.targetY = target.y;
                            }
                        }
                    }
                }
                
                // Jeśli przeciwnik ma dużą armię, zaatakuj gracza
                const warriors = this.enemy.units.filter(u => u.type === 'warrior' || u.type === 'archer');
                if (warriors.length >= 10) {
                    for (let warrior of warriors) {
                        if (this.player.buildings.length > 0) {
                            // Atakuj losowy budynek gracza
                            const targetIndex = Math.floor(Math.random() * this.player.buildings.length);
                            const target = this.player.buildings[targetIndex];
                            
                            warrior.task = 'attack';
                            warrior.taskTarget = target;
                            warrior.targetX = target.x;
                            warrior.targetY = target.y;
                        } else if (this.player.units.length > 0) {
                            // Atakuj losową jednostkę gracza
                            const targetIndex = Math.floor(Math.random() * this.player.units.length);
                            const target = this.player.units[targetIndex];
                            
                            warrior.task = 'attack';
                            warrior.taskTarget = target;
                            warrior.targetX = target.x;
                            warrior.targetY = target.y;
                        }
                    }
                }
            }
            
            updateUI() {
                // Aktualizacja liczników zasobów
                document.getElementById('gold').textContent = this.player.gold;
                document.getElementById('wood').textContent = this.player.wood;
                document.getElementById('food').textContent = this.player.food;
                document.getElementById('population').textContent = `${this.player.population}/${this.player.populationLimit}`;
            }
            
            render() {
                // Czyszczenie canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Początek transformacji kamery
                this.ctx.save();
                this.ctx.translate(
                    -this.camera.x * this.camera.scale + this.canvas.width / 2,
                    -this.camera.y * this.camera.scale + this.canvas.height / 2
                );
                this.ctx.scale(this.camera.scale, this.camera.scale);
                
                // Rysowanie siatki
                this.drawGrid();
                
                // Rysowanie terenu
                this.drawTerrain();
                
                // Rysowanie budynków i jednostek
                this.drawEntities();
                
                // Rysowanie ramki wyboru (jeśli aktywna)
                if (this.mouse.selectionBox.active) {
                    this.drawSelectionBox();
                }
                
                // Rysowanie celu budowania (jeśli w trybie budowania)
                if (this.buildMode) {
                    this.drawBuildingGhost();
                }
                
                // Koniec transformacji kamery
                this.ctx.restore();
                
                // Rysowanie minimapy
                this.drawMinimap();
            }
            
            drawGrid() {
                const gridSize = 100;
                const startX = Math.floor(this.camera.x - this.camera.width / (2 * this.camera.scale) / gridSize) * gridSize;
                const startY = Math.floor(this.camera.y - this.camera.height / (2 * this.camera.scale) / gridSize) * gridSize;
                const endX = Math.ceil(this.camera.x + this.camera.width / (2 * this.camera.scale) / gridSize) * gridSize;
                const endY = Math.ceil(this.camera.y + this.camera.height / (2 * this.camera.scale) / gridSize) * gridSize;
                
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.lineWidth = 1;
                
                // Pionowe linie
                for (let x = startX; x <= endX; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, startY);
                    this.ctx.lineTo(x, endY);
                    this.ctx.stroke();
                }
                
                // Poziome linie
                for (let y = startY; y <= endY; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(startX, y);
                    this.ctx.lineTo(endX, y);
                    this.ctx.stroke();
                }
            }
            
            drawTerrain() {
                // Rysowanie drzew
                for (let tree of this.terrain.trees) {
                    if (this.isVisibleOnScreen(tree.x, tree.y, tree.size)) {
                        this.ctx.fillStyle = '#228B22';
                        this.ctx.beginPath();
                        this.ctx.arc(tree.x, tree.y, tree.size, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        // Pień drzewa
                        this.ctx.fillStyle = '#8B4513';
                        this.ctx.beginPath();
                        this.ctx.arc(tree.x, tree.y, tree.size / 3, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                }
                
                // Rysowanie kopalni złota
                for (let mine of this.terrain.goldMines) {
                    if (this.isVisibleOnScreen(mine.x, mine.y, mine.size)) {
                        this.ctx.fillStyle = '#DAA520';
                        this.ctx.beginPath();
                        this.ctx.arc(mine.x, mine.y, mine.size, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        // Wewnętrzna część kopalni
                        this.ctx.fillStyle = '#B8860B';
                        this.ctx.beginPath();
                        this.ctx.arc(mine.x, mine.y, mine.size * 0.7, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                }
            }
            
            drawEntities() {
                // Rysowanie budynków gracza
                for (let building of this.player.buildings) {
                    if (this.isVisibleOnScreen(building.x, building.y, building.width)) {
                        this.drawBuilding(building, this.player.color);
                    }
                }
                
                // Rysowanie budynków przeciwnika
                for (let building of this.enemy.buildings) {
                    if (this.isVisibleOnScreen(building.x, building.y, building.width)) {
                        this.drawBuilding(building, this.enemy.color);
                    }
                }
                
                // Rysowanie jednostek gracza
                for (let unit of this.player.units) {
                    if (this.isVisibleOnScreen(unit.x, unit.y, unit.size)) {
                        this.drawUnit(unit, this.player.color);
                    }
                }
                
                // Rysowanie jednostek przeciwnika
                for (let unit of this.enemy.units) {
                    if (this.isVisibleOnScreen(unit.x, unit.y, unit.size)) {
                        this.drawUnit(unit, this.enemy.color);
                    }
                }
            }
            
            drawBuilding(building, color) {
                // Rysowanie budynku
                this.ctx.fillStyle = color;
                this.ctx.fillRect(
                    building.x - building.width / 2,
                    building.y - building.height / 2,
                    building.width,
                    building.height
                );
                
                // Obramowanie budynku
                this.ctx.strokeStyle = '#000';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(
                    building.x - building.width / 2,
                    building.y - building.height / 2,
                    building.width,
                    building.height
                );
                
                // Pasek zdrowia
                this.drawHealthBar(
                    building.x,
                    building.y - building.height / 2 - 10,
                    building.width,
                    5,
                    building.health / building.maxHealth
                );
                
                // Ikona typu budynku
                this.ctx.fillStyle = '#fff';
                this.ctx.font = '12px Arial';
                this.ctx.textAlign = 'center';
                
                let label = '';
                switch (building.type) {
                    case 'townHall': label = 'TH'; break;
                    case 'house': label = 'H'; break;
                    case 'barrack': label = 'B'; break;
                }
                
                this.ctx.fillText(
                    label,
                    building.x,
                    building.y + 5
                );
            }
            
            drawUnit(unit, color) {
                // Rysowanie jednostki
                this.ctx.fillStyle = color;
                this.ctx.beginPath();
                this.ctx.arc(unit.x, unit.y, unit.size, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Obramowanie (dla zaznaczonych jednostek)
                if (unit.selected) {
                    this.ctx.strokeStyle = '#fff';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.arc(unit.x, unit.y, unit.size + 2, 0, Math.PI * 2);
                    this.ctx.stroke();
                }
                
                // Pasek zdrowia
                this.drawHealthBar(
                    unit.x,
                    unit.y - unit.size - 5,
                    unit.size * 2,
                    3,
                    unit.health / unit.maxHealth
                );
                
                // Ikona typu jednostki
                this.ctx.fillStyle = '#fff';
                this.ctx.font = '10px Arial';
                this.ctx.textAlign = 'center';
                
                let label = '';
                switch (unit.type) {
                    case 'worker': label = 'W'; break;
                    case 'warrior': label = 'F'; break;
                    case 'archer': label = 'A'; break;
                }
                
                this.ctx.fillText(
                    label,
                    unit.x,
                    unit.y + 3
                );
            }
            
            drawHealthBar(x, y, width, height, percentage) {
                // Tło paska zdrowia
                this.ctx.fillStyle = '#800000';
                this.ctx.fillRect(x - width / 2, y - height / 2, width, height);
                
                // Pasek zdrowia
                this.ctx.fillStyle = '#00ff00';
                this.ctx.fillRect(
                    x - width / 2,
                    y - height / 2,
                    width * percentage,
                    height
                );
            }
            
            drawSelectionBox() {
                // Rysowanie ramki wyboru
                const {startX, startY, endX, endY} = this.mouse.selectionBox;
                
                // Przeliczamy współrzędne ekranu na współrzędne świata
                const worldStartX = (startX - this.canvas.width / 2) / this.camera.scale + this.camera.x;
                const worldStartY = (startY - this.canvas.height / 2) / this.camera.scale + this.camera.y;
                const worldEndX = (endX - this.canvas.width / 2) / this.camera.scale + this.camera.x;
                const worldEndY = (endY - this.canvas.height / 2) / this.camera.scale + this.camera.y;
                
                // Rysowanie ramki
                this.ctx.strokeStyle = '#fff';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(
                    worldStartX,
                    worldStartY,
                    worldEndX - worldStartX,
                    worldEndY - worldStartY
                );
            }
            
            drawBuildingGhost() {
                // Rysowanie "ducha" budynku w trybie budowania
                let width = 0;
                let height = 0;
                
                switch (this.buildMode) {
                    case 'townHall': width = 80; height = 80; break;
                    case 'house': width = 40; height = 40; break;
                    case 'barrack': width = 60; height = 60; break;
                }
                
                // Sprawdzenie, czy można budować w tym miejscu
                const canBuild = this.canBuildAt(this.mouse.worldX, this.mouse.worldY, width, height);
                
                // Rysowanie "ducha" budynku
                this.ctx.fillStyle = canBuild ? 'rgba(0, 255, 0, 0.3)' : 'rgba(255, 0, 0, 0.3)';
                this.ctx.fillRect(
                    this.mouse.worldX - width / 2,
                    this.mouse.worldY - height / 2,
                    width,
                    height
                );
                
                this.ctx.strokeStyle = canBuild ? 'rgba(0, 255, 0, 0.8)' : 'rgba(255, 0, 0, 0.8)';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(
                    this.mouse.worldX - width / 2,
                    this.mouse.worldY - height / 2,
                    width,
                    height
                );
            }
            
            drawMinimap() {
                // Czyszczenie minimapy
                this.minimapCtx.clearRect(0, 0, this.minimap.width, this.minimap.height);
                this.minimapCtx.fillStyle = '#0f380f';
                this.minimapCtx.fillRect(0, 0, this.minimap.width, this.minimap.height);
                
                // Współczynnik skali minimapy
                const scaleX = this.minimap.width / this.worldWidth;
                const scaleY = this.minimap.height / this.worldHeight;
                
                // Rysowanie zasobów
                // Drzewa
                this.minimapCtx.fillStyle = '#228B22';
                for (let tree of this.terrain.trees) {
                    this.minimapCtx.fillRect(
                        tree.x * scaleX - 1,
                        tree.y * scaleY - 1,
                        2,
                        2
                    );
                }
                
                // Kopalnie złota
                this.minimapCtx.fillStyle = '#DAA520';
                for (let mine of this.terrain.goldMines) {
                    this.minimapCtx.fillRect(
                        mine.x * scaleX - 2,
                        mine.y * scaleY - 2,
                        4,
                        4
                    );
                }
                
                // Rysowanie budynków
                // Budynki gracza
                this.minimapCtx.fillStyle = this.player.color;
                for (let building of this.player.buildings) {
                    this.minimapCtx.fillRect(
                        (building.x - building.width / 2) * scaleX,
                        (building.y - building.height / 2) * scaleY,
                        building.width * scaleX,
                        building.height * scaleY
                    );
                }
                
                // Budynki przeciwnika
                this.minimapCtx.fillStyle = this.enemy.color;
                for (let building of this.enemy.buildings) {
                    this.minimapCtx.fillRect(
                        (building.x - building.width / 2) * scaleX,
                        (building.y - building.height / 2) * scaleY,
                        building.width * scaleX,
                        building.height * scaleY
                    );
                }
                
                // Rysowanie jednostek (jako małe kropki)
                // Jednostki gracza
                this.minimapCtx.fillStyle = this.player.color;
                for (let unit of this.player.units) {
                    this.minimapCtx.fillRect(
                        unit.x * scaleX - 1,
                        unit.y * scaleY - 1,
                        2,
                        2
                    );
                }
                
                // Jednostki przeciwnika
                this.minimapCtx.fillStyle = this.enemy.color;
                for (let unit of this.enemy.units) {
                    this.minimapCtx.fillRect(
                        unit.x * scaleX - 1,
                        unit.y * scaleY - 1,
                        2,
                        2
                    );
                }
                
                // Rysowanie ramki widocznego obszaru
                this.minimapCtx.strokeStyle = '#fff';
                this.minimapCtx.lineWidth = 1;
                
                const viewportX = (this.camera.x - this.camera.width / (2 * this.camera.scale)) * scaleX;
                const viewportY = (this.camera.y - this.camera.height / (2 * this.camera.scale)) * scaleY;
                const viewportWidth = (this.camera.width / this.camera.scale) * scaleX;
                const viewportHeight = (this.camera.height / this.camera.scale) * scaleY;
                
                this.minimapCtx.strokeRect(viewportX, viewportY, viewportWidth, viewportHeight);
            }
            
            isVisibleOnScreen(x, y, size) {
                // Sprawdzenie, czy obiekt jest widoczny w obszarze kamery
                const screenX = (x - this.camera.x) * this.camera.scale + this.canvas.width / 2;
                const screenY = (y - this.camera.y) * this.camera.scale + this.canvas.height / 2;
                const scaledSize = size * this.camera.scale;
                
                return (
                    screenX + scaledSize >= 0 &&
                    screenX - scaledSize <= this.canvas.width &&
                    screenY + scaledSize >= 0 &&
                    screenY - scaledSize <= this.canvas.height
                );
            }
            
            handleMouseDown(e) {
                this.mouse.down = true;
                
                // Pobieranie pozycji myszki w obrębie canvasa
                const rect = this.canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // Zapisywanie początkowej pozycji dla ramki wyboru
                this.mouse.startX = mouseX;
                this.mouse.startY = mouseY;
                
                // Inicjalizacja ramki wyboru
                this.mouse.selectionBox = {
                    startX: mouseX,
                    startY: mouseY,
                    endX: mouseX,
                    endY: mouseY,
                    active: true
                };
                
                // Konwersja współrzędnych ekranu na współrzędne świata
                this.mouse.worldX = (mouseX - this.canvas.width / 2) / this.camera.scale + this.camera.x;
                this.mouse.worldY = (mouseY - this.canvas.height / 2) / this.camera.scale + this.camera.y;
                
                // Obsługa kliknięcia na minimapę
                const minimapRect = this.minimap.getBoundingClientRect();
                if (e.clientX >= minimapRect.left && e.clientX <= minimapRect.right &&
                    e.clientY >= minimapRect.top && e.clientY <= minimapRect.bottom) {
                    // Konwersja współrzędnych minimapy na współrzędne świata
                    const minimapX = e.clientX - minimapRect.left;
                    const minimapY = e.clientY - minimapRect.top;
                    
                    // Przesunięcie kamery do miejsca kliknięcia na minimapie
                    this.camera.x = (minimapX / this.minimap.width) * this.worldWidth;
                    this.camera.y = (minimapY / this.minimap.height) * this.worldHeight;
                    
                    // Dezaktywacja ramki wyboru
                    this.mouse.selectionBox.active = false;
                    return;
                }
                
                // Jeśli jesteśmy w trybie budowania, spróbuj zbudować budynek
                if (this.buildMode) {
                    this.tryBuildBuilding();
                    return;
                }
                
                // Prawy przycisk myszy - wydaj rozkaz wybranym jednostkom
                if (e.button === 2) {
                    this.issueOrderToSelectedUnits();
                    return;
                }
            }
            
            handleMouseMove(e) {
                // Pobieranie pozycji myszki w obrębie canvasa
                const rect = this.canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // Aktualizacja pozycji myszki
                this.mouse.x = mouseX;
                this.mouse.y = mouseY;
                
                // Konwersja współrzędnych ekranu na współrzędne świata
                this.mouse.worldX = (mouseX - this.canvas.width / 2) / this.camera.scale + this.camera.x;
                this.mouse.worldY = (mouseY - this.canvas.height / 2) / this.camera.scale + this.camera.y;
                
                // Aktualizacja ramki wyboru (jeśli aktywna)
                if (this.mouse.down && this.mouse.selectionBox.active) {
                    this.mouse.selectionBox.endX = mouseX;
                    this.mouse.selectionBox.endY = mouseY;
                }
            }
            
            handleMouseUp(e) {
                this.mouse.down = false;
                
                // Jeśli ramka wyboru jest aktywna, wybierz jednostki
                if (this.mouse.selectionBox.active) {
                    this.selectUnitsInSelectionBox();
                    this.mouse.selectionBox.active = false;
                }
            }
            
            handleMouseWheel(e) {
                // Zmiana skali kamery (zoom)
                e.preventDefault();
                
                const zoomAmount = 0.1;
                const prevScale = this.camera.scale;
                
                if (e.deltaY < 0) {
                    // Przybliżenie
                    this.camera.scale = Math.min(prevScale * (1 + zoomAmount), 2.0);
                } else {
                    // Oddalenie
                    this.camera.scale = Math.max(prevScale * (1 - zoomAmount), 0.5);
                }
            }
            
            handleKeyDown(e) {
                // Obsługa klawiszy
                switch (e.key) {
                    case 'Escape':
                        // Anulowanie trybu budowania
                        this.buildMode = null;
                        
                        // Odznaczenie wszystkich jednostek
                        for (let unit of this.player.units) {
                            unit.selected = false;
                        }
                        this.selectedUnits = [];
                        break;
                        
                    case 'ArrowUp':
                    case 'w':
                        // Przesunięcie kamery w górę
                        this.camera.y -= 20 / this.camera.scale;
                        break;
                        
                    case 'ArrowDown':
                    case 's':
                        // Przesunięcie kamery w dół
                        this.camera.y += 20 / this.camera.scale;
                        break;
                        
                    case 'ArrowLeft':
                    case 'a':
                        // Przesunięcie kamery w lewo
                        this.camera.x -= 20 / this.camera.scale;
                        break;
                        
                    case 'ArrowRight':
                    case 'd':
                        // Przesunięcie kamery w prawo
                        this.camera.x += 20 / this.camera.scale;
                        break;
                }
                
                // Ograniczenie kamery do granic świata
                this.camera.x = Math.max(0, Math.min(this.worldWidth, this.camera.x));
                this.camera.y = Math.max(0, Math.min(this.worldHeight, this.camera.y));
            }
            
            selectUnitsInSelectionBox() {
                // Odznaczenie wszystkich jednostek
                for (let unit of this.player.units) {
                    unit.selected = false;
                }
                this.selectedUnits = [];
                
                // Przeliczamy współrzędne ekranu na współrzędne świata
                const {startX, startY, endX, endY} = this.mouse.selectionBox;
                
                const worldStartX = (startX - this.canvas.width / 2) / this.camera.scale + this.camera.x;
                const worldStartY = (startY - this.canvas.height / 2) / this.camera.scale + this.camera.y;
                const worldEndX = (endX - this.canvas.width / 2) / this.camera.scale + this.camera.x;
                const worldEndY = (endY - this.canvas.height / 2) / this.camera.scale + this.camera.y;
                
                // Normalizowanie współrzędnych (aby startX < endX itp.)
                const left = Math.min(worldStartX, worldEndX);
                const right = Math.max(worldStartX, worldEndX);
                const top = Math.min(worldStartY, worldEndY);
                const bottom = Math.max(worldStartY, worldEndY);
                
                // Zaznaczanie jednostek w ramce
                for (let unit of this.player.units) {
                    if (unit.x >= left && unit.x <= right && unit.y >= top && unit.y <= bottom) {
                        unit.selected = true;
                        this.selectedUnits.push(unit);
                    }
                }
            }
            
            issueOrderToSelectedUnits() {
                if (this.selectedUnits.length === 0) return;
                
                // Sprawdzenie, czy kliknięto na wrogą jednostkę lub budynek
                let targetEnemy = this.getEntityAtPosition(this.mouse.worldX, this.mouse.worldY, this.enemy);
                
                if (targetEnemy) {
                    // Atak wrogiej jednostki lub budynku
                    for (let unit of this.selectedUnits) {
                        unit.task = 'attack';
                        unit.taskTarget = targetEnemy;
                        unit.targetX = targetEnemy.x;
                        unit.targetY = targetEnemy.y;
                    }
                    return;
                }
                
                // Sprawdzenie, czy kliknięto na zasób (drzewo, kopalnia złota)
                let targetResource = this.getResourceAtPosition(this.mouse.worldX, this.mouse.worldY);
                
                if (targetResource) {
                    // Zbieranie zasobów (tylko pracownicy)
                    for (let unit of this.selectedUnits) {
                        if (unit.type === 'worker') {
                            unit.task = 'gather';
                            unit.taskTarget = targetResource;
                            unit.targetX = targetResource.x;
                            unit.targetY = targetResource.y;
                        }
                    }
                    return;
                }
                
                // Ruch do wskazanej lokalizacji
                for (let unit of this.selectedUnits) {
                    // Lekko rozrzuć jednostki, aby się nie nakładały
                    const offsetX = Math.random() * 40 - 20;
                    const offsetY = Math.random() * 40 - 20;
                    
                    unit.targetX = this.mouse.worldX + offsetX;
                    unit.targetY = this.mouse.worldY + offsetY;
                    unit.task = null;
                    unit.taskTarget = null;
                }
            }
            
            getEntityAtPosition(x, y, faction) {
                // Sprawdzenie budynków
                for (let building of faction.buildings) {
                    if (
                        x >= building.x - building.width / 2 &&
                        x <= building.x + building.width / 2 &&
                        y >= building.y - building.height / 2 &&
                        y <= building.y + building.height / 2
                    ) {
                        return building;
                    }
                }
                
                // Sprawdzenie jednostek
                for (let unit of faction.units) {
                    const dx = x - unit.x;
                    const dy = y - unit.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance <= unit.size) {
                        return unit;
                    }
                }
                
                return null;
            }
            
            getResourceAtPosition(x, y) {
                // Sprawdzenie drzew
                for (let tree of this.terrain.trees) {
                    const dx = x - tree.x;
                    const dy = y - tree.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance <= tree.size) {
                        return tree;
                    }
                }
                
                // Sprawdzenie kopalni złota
                for (let mine of this.terrain.goldMines) {
                    const dx = x - mine.x;
                    const dy = y - mine.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance <= mine.size) {
                        return mine;
                    }
                }
                
                return null;
            }
            
            setBuildMode(mode) {
                this.buildMode = mode;
                
                // Odznacz przyciski
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(button => button.classList.remove('selected'));
                
                // Zaznacz odpowiedni przycisk
                switch (mode) {
                    case 'townHall':
                        document.getElementById('buildTownHall').classList.add('selected');
                        break;
                    case 'house':
                        document.getElementById('buildHouse').classList.add('selected');
                        break;
                    case 'barrack':
                        document.getElementById('buildBarrack').classList.add('selected');
                        break;
                }
            }
            
            tryBuildBuilding() {
                let cost = {gold: 0, wood: 0};
                let width = 0;
                let height = 0;
                
                // Określenie kosztu i rozmiaru budynku
                switch (this.buildMode) {
                    case 'townHall':
                        cost = {gold: 300, wood: 200};
                        width = 80;
                        height = 80;
                        break;
                    case 'house':
                        cost = {gold: 100, wood: 150};
                        width = 40;
                        height = 40;
                        break;
                    case 'barrack':
                        cost = {gold: 200, wood: 150};
                        width = 60;
                        height = 60;
                        break;
                }
                
                // Sprawdzenie, czy gracz ma wystarczająco zasobów
                if (this.player.gold < cost.gold || this.player.wood < cost.wood) {
                    console.log('Niewystarczająco zasobów!');
                    return;
                }
                
                // Sprawdzenie, czy można budować w tym miejscu
                if (!this.canBuildAt(this.mouse.worldX, this.mouse.worldY, width, height)) {
                    console.log('Nie można budować w tym miejscu!');
                    return;
                }
                
                // Budowanie
                this.player.buildings.push({
                    type: this.buildMode,
                    x: this.mouse.worldX,
                    y: this.mouse.worldY,
                    width: width,
                    height: height,
                    health: this.getBuildingHealth(this.buildMode),
                    maxHealth: this.getBuildingHealth(this.buildMode)
                });
                
                // Odjęcie kosztu
                this.player.gold -= cost.gold;
                this.player.wood -= cost.wood;
                
                // Aktualizacja limitu populacji dla domu
                if (this.buildMode === 'house') {
                    this.player.populationLimit += 5;
                }
                
                // Wyłączenie trybu budowania
                this.buildMode = null;
                
                // Odznaczenie przycisków
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(button => button.classList.remove('selected'));
            }
            
            getBuildingHealth(type) {
                switch (type) {
                    case 'townHall': return 1000;
                    case 'house': return 300;
                    case 'barrack': return 500;
                    default: return 100;
                }
            }
            
            canBuildAt(x, y, width, height) {
                // Sprawdzenie, czy budynek jest w granicach świata
                if (
                    x - width / 2 < 0 ||
                    x + width / 2 > this.worldWidth ||
                    y - height / 2 < 0 ||
                    y + height / 2 > this.worldHeight
                ) {
                    return false;
                }
                
                // Sprawdzenie, czy budynek nie koliduje z innymi budynkami
                for (let building of this.player.buildings) {
                    if (
                        x + width / 2 > building.x - building.width / 2 &&
                        x - width / 2 < building.x + building.width / 2 &&
                        y + height / 2 > building.y - building.height / 2 &&
                        y - height / 2 < building.y + building.height / 2
                    ) {
                        return false;
                    }
                }
                
                for (let building of this.enemy.buildings) {
                    if (
                        x + width / 2 > building.x - building.width / 2 &&
                        x - width / 2 < building.x + building.width / 2 &&
                        y + height / 2 > building.y - building.height / 2 &&
                        y - height / 2 < building.y + building.height / 2
                    ) {
                        return false;
                    }
                }
                
                // Sprawdzenie, czy budynek nie koliduje z drzewami
                for (let tree of this.terrain.trees) {
                    if (
                        x + width / 2 > tree.x - tree.size &&
                        x - width / 2 < tree.x + tree.size &&
                        y + height / 2 > tree.y - tree.size &&
                        y - height / 2 < tree.y + tree.size
                    ) {
                        return false;
                    }
                }
                
                // Sprawdzenie, czy budynek nie koliduje z kopalniami złota
                for (let mine of this.terrain.goldMines) {
                    if (
                        x + width / 2 > mine.x - mine.size &&
                        x - width / 2 < mine.x + mine.size &&
                        y + height / 2 > mine.y - mine.size &&
                        y - height / 2 < mine.y + mine.size
                    ) {
                        return false;
                    }
                }
                
                return true;
            }
            
            trainUnit(type) {
                // Sprawdzenie, czy gracz ma wystarczająco zasobów
                let cost = {gold: 0, wood: 0};
                
                switch (type) {
                    case 'worker':
                        cost = {gold: 50, wood: 0};
                        break;
                    case 'warrior':
                        cost = {gold: 100, wood: 0};
                        break;
                    case 'archer':
                        cost = {gold: 75, wood: 50};
                        break;
                }
                
                if (this.player.gold < cost.gold || this.player.wood < cost.wood) {
                    console.log('Niewystarczająco zasobów!');
                    return;
                }
                
                // Sprawdzenie, czy gracz ma miejsce na nową jednostkę
                if (this.player.population >= this.player.populationLimit) {
                    console.log('Osiągnięto limit populacji!');
                    return;
                }
                
                // Sprawdzenie, czy gracz ma odpowiedni budynek
                let canTrain = false;
                let spawnBuilding = null;
                
                if (type === 'worker') {
                    // Pracowników można trenować w ratuszu
                    spawnBuilding = this.player.buildings.find(b => b.type === 'townHall');
                    canTrain = spawnBuilding !== undefined;
                } else if (type === 'warrior' || type === 'archer') {
                    // Wojowników i łuczników można trenować w koszarach
                    spawnBuilding = this.player.buildings.find(b => b.type === 'barrack');
                    canTrain = spawnBuilding !== undefined;
                }
                
                if (!canTrain) {
                    console.log('Brak odpowiedniego budynku!');
                    return;
                }
                
                // Tworzenie jednostki
                let unitStats = {
                    size: 0,
                    speed: 0,
                    health: 0,
                    maxHealth: 0,
                    attack: 0,
                    range: 0,
                    attackSpeed: 0
                };
                
                switch (type) {
                    case 'worker':
                        unitStats = {
                            size: 8,
                            speed: 1.5,
                            health: 50,
                            maxHealth: 50,
                            attack: 5,
                            range: 10,
                            attackSpeed: 1
                        };
                        break;
                    case 'warrior':
                        unitStats = {
                            size: 10,
                            speed: 1.2,
                            health: 100,
                            maxHealth: 100,
                            attack: 15,
                            range: 15,
                            attackSpeed: 1
                        };
                        break;
                    case 'archer':
                        unitStats = {
                            size: 9,
                            speed: 1.3,
                            health: 70,
                            maxHealth: 70,
                            attack: 10,
                            range: 100,
                            attackSpeed: 0.8
                        };
                        break;
                }
                
                this.player.units.push({
                    type: type,
                    x: spawnBuilding.x + Math.random() * 60 - 30,
                    y: spawnBuilding.y + Math.random() * 60 - 30,
                    targetX: null,
                    targetY: null,
                    size: unitStats.size,
                    speed: unitStats.speed,
                    health: unitStats.health,
                    maxHealth: unitStats.maxHealth,
                    attack: unitStats.attack,
                    range: unitStats.range,
                    attackSpeed: unitStats.attackSpeed,
                    lastAttack: 0,
                    selected: false,
                    task: null,
                    taskTarget: null
                });
                
                // Odjęcie kosztu
                this.player.gold -= cost.gold;
                this.player.wood -= cost.wood;
                
                // Zwiększenie populacji
                this.player.population++;
            }
        }
        
        // Inicjalizacja gry po załadowaniu strony
        let game;
        window.addEventListener('load', () => {
            console.log("Window loaded, initializing game...");
            
            try {
                game = new Game();
                console.log("Game initialized successfully!");
                
                // Zapobieganie domyślnemu menu kontekstowemu przeglądarki
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
            } catch (error) {
                console.error("Error initializing game:", error);
            }
        });
    </script>
</body>
</html>